{% extends 'base_generic.html' %}
{% load static %}

{% block content %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지</title>
    <link rel="stylesheet" href="{% static 'admin/css/mypage.css' %}">
</head>
<body>
    <div class="luxury-container">
        <header>
            <h1 class="header-title">마이페이지</h1>
            <p class="username">사용자이름: {{ user.username }}</p>
        </header>

        {% if messages %}
        <div class="luxury-messages">
            {% for message in messages %}
            <div class="luxury-alert {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <nav>
            <ul class="nav-list">
                <li><a href="#change-password">비밀번호 변경</a></li>
                <li><a href="#my-reviews">내가 쓴 리뷰</a></li>
                <li><a href="#my-posts">내가 쓴 게시판</a></li>
                <li><a href="#change-profile-picture">프로필 사진 변경</a></li>
                <li><a href="#liked-restaurants">즐겨찾기</a></li>
            </ul>
        </nav>

        <main>
            <section id="change-profile-picture" class="luxury-section">
                <h2>프로필 사진 변경</h2>
                <div class="luxury-profile-pic-container">
                    {% if profile.profile_picture %}
                    <img src="{{ profile.profile_picture.url }}" alt="Profile Picture" class="luxury-profile-pic">
                    <form method="POST" class="luxury-form" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit1" name="delete_picture" class="delete-button">삭제하기</button>
                    </form>
                    {% else %}
                    <img src="{% static 'Profile_pictures/default.jpg' %}" alt="Default Profile Picture" class="luxury-profile-pic">
                    <p>기본 프로필 사진입니다. 삭제할 수 없습니다.</p>
                    {% endif %}
                </div>
                <form method="POST" enctype="multipart/form-data" class="luxury-form">
                    {% csrf_token %}
                    <div class="file-upload">
                        <input type="file" name="profile_picture" class="luxury-input" accept="image/*">

                    </div>
                    <button type="submit1" name="profile_picture" class="luxury-button">업로드하기</button>
                </form>
            </section>

            <section id="change-password" class="luxury-section">
                <h2>비밀번호 변경</h2>
                <button type="button" class="btn btn-link" id="togglePasswordChange">변경하기</button>
                <div id="passwordChangeForm" class="collapse" style="display: none;">
                    <form method="POST" class="luxury-form">
                        {% csrf_token %}
                        <div class="password-fields">
                            <div class="password-field">
                                <label for="current_password">기존 비밀번호:</label>
                                <input type="password" name="current_password" id="current_password" class="luxury-input">
                            </div>
                            <div class="password-field">
                                <label for="new_password">새 비밀번호:</label>
                                <input type="password" name="new_password" id="new_password" class="luxury-input">
                            </div>
                            <div class="password-field">
                                <label for="confirm_password">새 비밀번호(확인):</label>
                                <input type="password" name="confirm_password" id="confirm_password" class="luxury-input">
                            </div>
                        </div>

                        <div class="password-rules">
                            <p>다른 개인 정보와 유사한 비밀번호는 사용할 수 없습니다.</p>
                            <p>비밀번호는 최소 8자 이상이어야 합니다.</p>
                            <p>통상적으로 자주 사용되는 비밀번호는 사용할 수 없습니다.</p>
                            <p>숫자로만 이루어진 비밀번호는 사용할 수 없습니다.</p>
                        </div>

                        <button type="submit" name="password_change" class="luxury-button">변경하기</button>
                    </form>
                </div>
            </section>

            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                $(document).ready(function () {
                    $('#togglePasswordChange').click(function () {
                        $('#passwordChangeForm').toggleClass('show'); // 'show' 클래스 토글
                    });
                });
            </script>


            <section id="my-reviews" class="luxury-section">
                <h2>내가 쓴 리뷰</h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col" class="text-center">구분</th>
                            <th scope="col" class="text-center">가게명</th>
                            <th scope="col" class="text-center">리뷰 내용</th>
                            <th scope="col" class="text-center">평점</th>
                            <th scope="col" class="text-center">작성일</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for review in reviews %}
                        <tr>
                            <td class="text-center">리뷰</td>
                            <td class="text-center">
                                <a href="{% url 'restaurant_view' review.restaurant.id %}">{{ review.restaurant.name }}</a>
                            </td>
                            <td>
                                <a href="{% url 'reviews' review.restaurant.id %}">{{ review.text|truncatewords:10 }}</a> <!-- 리뷰 내용 링크 -->
                            </td>
                            <td class="text-center">{{ review.rating }}</td>
                            <td class="text-center">{{ review.created_at|date:"Y.m.d" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">작성한 리뷰가 없습니다.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>


            <section id="my-posts" class="luxury-section">
                <h2>내가 쓴 게시글</h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col" class="text-center">구분</th>
                            <th scope="col" class="text-center">제목</th>
                            <th scope="col" class="text-center">작성자</th>
                            <th scope="col" class="text-center">추천</th>
                            <th scope="col" class="text-center">조회수</th>
                            <th scope="col" class="text-center">작성일</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in posts %}
                        <tr>
                            <td class="text-center">자유</td>
                            <td>
                                <a href="{% url 'post_detail' post.id %}">{{ post.title }}</a>
                            </td>
                            <td class="text-center">{{ post.author.username }}</td>
                            <td class="text-center">{{ post.likes }}</td>
                            <td class="text-center">{{ post.views }}</td>
                            <td class="text-center">{{ post.created_at|date:"Y.m.d" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">작성한 게시글이 없습니다.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
            <section id="liked-restaurants" class="luxury-section">
                <h2>즐겨찾기</h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th scope="col" class="text-center">가게명</th>
                            <th scope="col" class="text-center">위치</th>
                            <th scope="col" class="text-center">카테고리</th>
                            <th scope="col" class="text-center">좋아요 수</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if liked_restaurants %}
                        {% for restaurant in liked_restaurants %}
                        <tr>
                            <td class="text-center">
                                <a href="{% url 'restaurant_view' restaurant.id %}">{{ restaurant.name }}</a>
                            </td>
                            <td class="text-center">{{ restaurant.location }}</td>
                            <td class="text-center">{{ restaurant.category.name }}</td> <!-- 카테고리 이름을 가져옴 -->
                            <td class="text-center">{{ restaurant.like_set.count }}</td> <!-- 좋아요 수 -->
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center">즐겨찾기 한 가게가 없습니다.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </section>
        </main>
    </div>
    
</body>
</html>

{% endblock %}
